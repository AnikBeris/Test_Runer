name: V2 UPDATE-README

on:
  workflow_dispatch:
  schedule:
    - cron: '10 9 * * *'
  push:
    branches: [ main ]
    paths:
      - ".github/README_PARTS/*"
      - ".github/README_PARTS/5.MAIN_Article_*.md"

permissions:
  contents: write          # Обязательно!
  pull-requests: write

jobs:
  # 1. Подготовка (просто информация + checkout)
  prepare:
    runs-on: ubuntu-latest
    name: Подготовка
    steps:
      - name: Информация о запуске
        run: |
          echo "Запуск: ${{ github.event_name }}"
          echo "Репозиторий: ${{ github.repository }}"
          date '+%Y-%m-%d %H:%M:%S'
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

  # 2. Настройка Git (отдельный шаг — красиво в логах)
  setup-git:
    needs: prepare
    runs-on: ubuntu-latest
    name: Настройка Git
    steps:
      - name: Конфиг Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

  # 3. Сборка README.md
  compile-readme:
    needs: setup-git
    runs-on: ubuntu-latest
    name: Сборка README
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Сборка README.md
        run: |
          # ← твой полный скрипт сборки (тот же, что был раньше) ←
          PARTS=".github/README_PARTS"
          OUTPUT="README.md"
          # ... весь твой код сборки ...
          echo "README.md собран!"

      # Ключевое: сохраняем только один файл как артефакт
      - name: Сохранить собранный README
        uses: actions/upload-artifact@v4
        with:
          name: compiled-readme
          path: README.md
          retention-days: 1

  # 4. Создание PR — без запуска новой VM с нуля!
  create-pull-request:
    needs: compile-readme
    runs-on: ubuntu-latest
    name: Создание Pull Request
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Берём готовый файл из предыдущего job-а
      - name: Скачать собранный README.md
        uses: actions/download-artifact@v4
        with:
          name: compiled-readme
          path: .

      # Теперь файл снова в корне и видим для create-pull-request
      - name: Создать Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: regenerate README from parts"
          title: "Обновлён README из частей (автосборка)"
          body: |
            Автоматическая сборка README.md из файлов в `.github/README_PARTS/`

            Триггер: ${{ github.event_name }}
            Коммит: ${{ github.sha }}

            Что изменилось:
            • Заголовок, описание, донаты
            • Навигация
            • Все статьи `5.MAIN_Article_*.md` (добавлены/обновлены/отсортированы)
            • Футер

            Можно мержить одной кнопкой — чистая автогенерация.

          branch: readme/auto-update            # временная ветка
          base: main
          delete-branch: true
          labels: |
            automated
            documentation
          add-paths: README.md