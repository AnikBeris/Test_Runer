name: V2 UPDATE-README

on:
  workflow_dispatch:
  schedule:
    - cron: '10 9 * * *'           # каждый день в 12:10 по Москве
  push:
    branches: [ main ]
    paths:
      - ".github/README_PARTS/*"
      - ".github/README_PARTS/5.MAIN_Article_*.md"

# Теперь достаточно только чтения + создания PR
permissions:
  contents: read
  pull-requests: write

  
jobs:
  build-and-pr:
    runs-on: ubuntu-latest
    name: Подгатовка
    steps:
      # 1. Информация о запуске
      - name: Вывод информации о запуске
        run: |
          echo "Запущено событием: ${{ github.event_name }}"
          echo "Репозиторий: ${{ github.repository }}"
          echo "Ветка: ${{ github.ref_name }}"
          date

      # 2. Клонируем репозиторий
      - name: Клонирование репозитория
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

  Opttions-Git:
    needs: build-and-pr
    runs-on: ubuntu-latest
    steps:
      # 3. Настраиваем git (нужно для create-pull-request)
      - name: Настройка Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"



  Compiling-README:
    needs: Opttions-Git
    runs-on: ubuntu-latest
    steps:
      # 4. Собираем README.md из частей
      - name: Сборка README.md из частей
        run: |
          PARTS=".github/README_PARTS"
          OUTPUT="README.md"

          HEADER="$PARTS/1.HEADER.md"
          DESCRIPTION="$PARTS/2.DESCRIPTION.md"
          DONATION="$PARTS/3.DONATION.md"
          NAV="$PARTS/4.NAV.md"
          MAIN_Header="$PARTS/5.MAIN_Header.md"
          FOOTER="$PARTS/6.FOOTER.md"

          MAIN_ARTICLES=$(ls "$PARTS"/5.MAIN_Article_*.md 2>/dev/null | sort -V || echo "")

          echo "Найдены статьи MAIN_Article_:"
          echo "$MAIN_ARTICLES" | sed 's/^/  • /' || true

          # Проверка наличия обязательных файлов
          for file in "$HEADER" "$DESCRIPTION" "$DONATION" "$NAV" "$MAIN_Header" "$FOOTER"; do
            [[ -f "$file" ]] || { echo "ОШИБКА: не найден $file"; exit 1; }
          done

          echo "Начинаем сборку $OUTPUT …"
          > "$OUTPUT"

          cat "$HEADER"        >> "$OUTPUT"; echo -e "\n\n" >> "$OUTPUT"
          cat "$DESCRIPTION"   >> "$OUTPUT"; echo -e "\n\n" >> "$OUTPUT"
          cat "$DONATION"      >> "$OUTPUT"; echo -e "\n\n" >> "$OUTPUT"
          cat "$NAV"           >> "$OUTPUT"; echo -e "\n\n" >> "$OUTPUT"
          cat "$MAIN_Header"   >> "$OUTPUT"; echo -e "\n\n" >> "$OUTPUT"

          if [[ -n "$MAIN_ARTICLES" ]]; then
            for article in $MAIN_ARTICLES; do
              echo "Добавляем $(basename "$article")"
              cat "$article" >> "$OUTPUT"
              echo -e "\n\n" >> "$OUTPUT"
            done
          else
            echo "Внимание: статей не найдено"
          fi

          cat "$FOOTER" >> "$OUTPUT"
          echo -e "\n" >> "$OUTPUT"

          echo "README.md успешно собран!"


  Pull-Request:
    needs: Compiling-README
    runs-on: ubuntu-latest
    steps:
      # 5. Создаём Pull Request вместо прямого пуша
      - name: Создание Pull Request с обновлённым README
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: regenerate README from parts"
          title: "Обновлён README из частей"
          body: |
            Автоматическая пересборка README.md из файлов в `.github/README_PARTS/`

            Триггер: ${{ github.event_name }}
            Коммит: ${{ github.sha }}

            Что изменилось:
            • Заголовок, описание, донаты
            • Навигация
            • Все статьи `5.MAIN_Article_*.md` (добавлены/обновлены/отсортированы)
            • Футер

            Можно мержить одной кнопкой — это чистая автогенерация

          branch: readme/auto-update            # временная ветка
          base: main
          delete-branch: true
          labels: |
            automated
            documentation
          add-paths: |
            README.md