name: Translate Lessons

on:
  workflow_dispatch: # ручной запуск

#  push:
#    branches:
#      - main
#    paths:
#      - "README.md"

permissions:
  contents: write
  pull-requests: write
  models: read

jobs:
  translate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        language: ["spanish", "english", "chinese"]
        include:
          - language: "spanish"
            file: "README.es.md"
          - language: "chinese"
            file: "README.zh.md"
          - language: "english"
            file: "README.en.md"

    steps:
      - uses: actions/checkout@v4

      - name: Translate File
        uses: FidelusAleksander/ai-translate-action@v1
        id: translate
        with:
          text-file: "README.md"
          target-language: ${{ matrix.language }}
          custom-instructions: "Технические термины используйте только на английском. Не переводите блоки кода или URL."

      - name: Save Translation
        run: |
          mkdir -p docs
          echo "$TRANSLATED_TEXT" | tee docs/${{ matrix.file }}
        env:
          TRANSLATED_TEXT: ${{ steps.translate.outputs.translated-text }}

      - name: Fix media paths
        run: |
          sed -i 's|\.\/media/|../media/|g' docs/${{ matrix.file }}
          sed -i -E 's|(\.\./)+media/|../media/|g' docs/${{ matrix.file }}

      - name: Upload Translation Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.file }}
          path: docs/${{ matrix.file }}

  generate-language-file:
    needs: translate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: docs
          merge-multiple: true

      - name: Generate .github/README_PARTS/0.Language.md
        run: |
          mkdir -p .github/README_PARTS
          OUTPUT=".github/README_PARTS/0.Language.md"

          echo '<p align="center">' > $OUTPUT
          echo '  <strong>-------></strong>' >> $OUTPUT

          # Русский (основной README.md)
          echo '  <a href="/README.md">Русский</a> |' >> $OUTPUT

          # Переводы из docs/
          for file in docs/README.*.md; do
            filename=$(basename "$file")

            # пропускаем самую себя, если вдруг
            if [[ "$filename" == "0.Language.md" ]]; then
              continue
            fi

            lang=$(echo "$filename" | sed -E 's/README\.([a-z]+)\.md/\1/')

            case "$lang" in
              en) langName="English" ;;
              es) langName="Spanish" ;;
              zh) langName="Chinese" ;;
              ru) langName="Русский" ;;
              *) langName="$lang" ;;
            esac

            echo "  <a href=\"/docs/$filename\">$langName</a> |" >> $OUTPUT
          done

          echo '  <strong><-------</strong>' >> $OUTPUT
          echo '</p>' >> $OUTPUT

      - name: Upload Language Index Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LanguageIndex
          path: .github/README_PARTS/0.Language.md

  create-pr:
    needs: [translate, generate-language-file]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: .
          merge-multiple: true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: update translations + language index"
          title: "docs: update translations + language index"
          body: |
            This PR updates translations and regenerates language index automatically.
          branch: docs/update-translations
          add-paths: |
            docs/README*
            .github/README_PARTS/0.Language.md
          delete-branch: true
          labels: |
            documentation
            translation
